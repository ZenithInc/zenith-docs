# 分库分表

这一篇文档介绍了分库分表相关内容。

## 为什么要分库分表 {id="why"}

换句话说，什么时候需要分库分表，如下这些情况:

- 因为很多接口性能问题都是数据库造成的
- 所以并发量比较大的时候，大量的数据库请求，会带来磁盘 IO 的性能瓶颈
- 随着数据越来越多，SQL 查询即使走了索引也会比较慢

## 分库分表的应用场景 {id="usecase"}

分库和分表是两个不同的概念，解决的问题也不一样。

- 并发量很大，但是数据量很少，这时候，可以分库，不分表。
- 当并发量不大，但是数据量比较大的时候，可以只分表，不分库。
- 当并发量很大，数据量也很大的时候，既需要分库，也需要分表。

分库分表的拆分有两个方向，一个是垂直，一个是水平。一般我们会优先选择垂直拆分，然后再水平拆分，因为垂直拆分更简单也更符合实际业务。

## 垂直拆分 {id="vertical"}

比如垂直分库，针对一个系统的不同业务进行拆分。比如用户拆分到 `user`库，商品拆分到`goods`库，订单拆分到 `order`库。拆分后放在不同的服务器上。在高并发下一定程序能解决 IO、连接数、硬件资源等瓶颈。

![image.png](http://file-linker.oss-cn-hangzhou.aliyuncs.com/eZIei8ezVpcXpAoCmBBe.png)

比如垂直分表，就是”大表拆成小表“，基于表中字段拆分，将不常用的，数据较大的拆分到扩展表，一般针对几百列的大表进行拆分。

垂直拆分的特点是，每个库表的结构都是不一样的，但是数据至少都有外键来关联，并且每一个库表都是全量数据。拆分后业务清晰，维护简单，保存在不同的数据库中，解决了 IO问题。　

垂直拆分的缺点是，单表数量大的时候，读写压力依然大。另外，受到业务影响，热门业务压力大，冷门业务造成资源浪费。

## 水平拆分 {id="horizontal"}

水平分表针对的是数量量巨大的单表，按照某种规则，拆分到多个表中，但是这些表还是在一个库中的。分库也是一样的。

![image.png](http://file-linker.oss-cn-hangzhou.aliyuncs.com/bFjPmhACgqYjKjMiSIRh.png)

比如说日志表，按照年或年月进行拆分。或者按照范围拆分，10万一张表。或者按照 HASH 取模来拆分，比如用户表拆分成 10 张表，就用户 ID 对 10 取余。 还有就是按照地理区域划分，比如华东、东北等。

有点是单表单库数据量减少，有利于性能，程序改动比较小。缺点是比较难扩容，比如说取模的值变了，原本是 10 张表，要扩展到 15 张表。 这时候要对旧数据都要重新处理一下。

## 一致性哈希算法 {id="consistency-hash"}

一致性哈希算法是 1997 年麻省理工学院的 Karger 等人在解决分布式缓存中提出的。可以参考下面这篇文章:

- [一致性哈希算法原理-博客园](https://www.cnblogs.com/lpfuture/p/5796398.html)

这个算法原始的论文在下面这个链接:

- [Consistent hashing and random trees:distributed caching protocols for relieving hot spots on the World Wide Web](https://dl.acm.org/doi/10.1145/258533.258660)

有时间再来补充这块内容。
